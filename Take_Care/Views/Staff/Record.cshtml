@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@model IEnumerable<Take_Care.Models.ServiceHistoryViewModel>


@await Html.PartialAsync("_HeadPartial")

<body>
	<div class="container">
		<div class="row">
			<div class="col-2 ">
				<div class="row" id="userPic" style="background-color: white">
					<img src="~/img/Staff/F01.png"
						 alt="user">
					<span class="row" style="margin-top: 10px">
						TC0001
					</span>
				</div>
				@await Html.PartialAsync("_SideBarPartial")
			</div>
			<div class="col-10" id="mainPage">
				<div class="container emp-profile" style="margin:0px">
					<form method="post">

						<div class="row">
							<!-- 服務歷史紀錄 -->
							<div class="col" id="">
								<div class="">
									<div>
										<div style="font-size: 40px; margin-top: 30px;">服務歷史紀錄</div>
										<div style="font-size: 30px;"></div>
										<hr>
									</div>
									<br>
									<!-- 用日期查詢服務歷史紀錄 -->
									<div>
										
											<label style="font-size: 23px"><b>開始日期:</b></label>
											<input type="text" placeholder="YYYY-MM-DD" name="startDate" id="datepickerStart" style="width: 180px">
											&nbsp;&nbsp;

											<label style="font-size: 23px"><b>結束日期:</b></label>
											<input type="text" placeholder="YYYY-MM-DD" name="endDate" id="datepickerEnd" style="width: 180px">
											&nbsp;&nbsp;

											<button class="qbutton" id="queryBtn">查詢</button>


										    <!-- 金額合計 -->
											<span style="font-size: 24px; float: right; margin-right: 60px;">
												<span id="moneyA" style="">
													<b>金額合計: $@ViewBag.TotalAmount</b>
												</span>
											</span>
										
									</div>
									<!-- 表格 -->
									<div id="tableA" style="">
										<table class="table table-bordered align-middle" style="margin-top: 40px;">
											<tr style="">												
												<th style="background-color: burlywood;">服務日期</th>
												<th style="background-color: burlywood;">服務時間</th>
												<th style="background-color: burlywood;">案主名稱</th>
												<th style="background-color: burlywood;">服務項目</th>
												<th style="background-color: burlywood;">服務金額</th>
											</tr>
											@if (Model != null)
											{
												foreach (var item in Model)
												{													
													<tr class="serviceRow" id="dataRow">
														<td class="serviceDate">@item.ServiceDate.ToString("yyyy-MM-dd")</td>
														<td>@item.ServiceTime.ToString("hh\\:mm")</td>
														<td>@item.EmployerName</td>
														<td>@item.ServiceItem</td>
														<td class="serviceAmount">$@item.ServiceAmount</td>
													</tr>
												}
											}
											else
											{
												<tr>
													<td colspan="5">沒有歷史資料可顯示</td>
												</tr>
											}
											

										</table>
									</div>



								</div>
							</div>

						</div>
					</form>
				</div>
			</div>
		</div>
	</div>	

	<script src="~/js/CsMember/jquery.twzipcode.min.js"></script>
	<script src="~/js/CsMember/getaddress.js"></script>
	<script src="~/js/CsMember/profile.js"></script>
	<script src="~/js/CsMember/Prev&Next.js"></script>
	<script src="~/js/CsMember/changeTabHref.js"></script>


	<script>

		$(function () {
			$("#datepickerStart, #datepickerEnd").datepicker({
				dateFormat: "yy-mm-dd"
			});
		});

		$("#twzipcode").twzipcode();
		$("#twzipcode2").twzipcode();
		$("#twzipcode3").twzipcode();
	</script>

	<script>
		//從Session Storage中獲取用户帳戶資料
		$(document).ready(function () {
			var _userAccount = JSON.parse(sessionStorage.getItem('member')).account;
			console.log("userAccount:", _userAccount);
			

			// 使用 AJAX 將 userAccount 傳遞給 Controller
			$.ajax({
				url: '/Staff/Record',
				type: 'POST', // 或者 'GET'，取決於您的 Controller 設置
				data: { account: _userAccount },
				success: function () {
					// 成功處理回應
					console.log("請求userAccount成功");
					//console.log("回應資料:", response); // 可以查看返回的資料
				},
				error: function (xhr, status, error) {
					// 處理錯誤
					console.log("請求userAccount失敗");
					console.log("Status: ", status); // 可以查看錯誤狀態
					console.log("Error: ", error);   // 可以查看錯誤原因
				}
			});			
		});

		//處理表單提交事件
		$("#queryBtn").click(function () {
			
			event.preventDefault(); // 阻止表單的默認提交行為

			var startDate = new Date($("#datepickerStart").val());
			var endDate = new Date($("#datepickerEnd").val());

			$(".serviceRow").each(function () {
				var rowDate = new Date($(this).find(".serviceDate").text());
				if (rowDate >= startDate && rowDate <= endDate) {
					$(this).show();
				} else {
					$(this).hide();
				}
			});
			
			// 重新計算金額合計
			var totalAmount = 0;
			var hasData = false; // 檢查是否有資料

			$(".serviceRow:visible").each(function () {
				var amountStr = $(this).find(".serviceAmount").text().substring(1); // 去除前面的$
				console.log("金額字串:", amountStr); // 檢查金額字串是否正確
				var amount = parseInt(amountStr); // 將金額字符串轉換為整數
				console.log("解析後的金額:", amount); // 檢查解析後的金額是否正確
				if (!isNaN(amount)) { // 確保轉換成功
					totalAmount += amount;
					hasData = true; // 如果有資料，設置為 true
				}
			});

			// 更新金額合計顯示為整數
			$("#moneyA").text("金額合計: $" + totalAmount);

			// 如果沒有資料，顯示"沒有歷史資料可顯示"
			if (!hasData) {
				$("#tableA").append('<tr><td colspan="5">沒有歷史資料可顯示</td></tr>');				
			} else {
				$("#tableA td[colspan='5']").parent().remove(); // 移除可能存在的資料
			}
		});

	</script>


</body>
