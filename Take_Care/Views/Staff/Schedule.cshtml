@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@

@model IEnumerable<Take_Care.Models.ServiceHistoryViewModel>

@await Html.PartialAsync("_HeadPartial")


<body>
	<div class="container">
		<div class="row">
			<div class="col-2 ">
				<div class="row" id="userPic" style="background-color: white">
					<img src="~/img/Staff/F01.png"
						 alt="user">
					<span class="row" style="margin-top: 10px">
						TC0001
					</span>
				</div>
				@await Html.PartialAsync("_SideBarPartial")
			</div>
			<div class="col-10" id="mainPage">
				<div class="container emp-profile" style="margin:0px">
					<form method="post">

						<div class="row">
							<!-- 我的排程 -->
							<div class="col" id="">
								<div class="">
									<div>
										<div style="font-size: 40px; margin-top: 30px;">我的排程</div>
										<div style="font-size: 30px;"></div>
										<hr>
									</div>
									<br>
									<!-- 根據日期查詢預約排程 -->
									<div>
										<label style="font-size: 23px"><b>開始日期:</b></label>
										<input type="text" placeholder="YYYY-MM-DD" name="startdate" id="datepickerStart" style="width: 180px">
										&nbsp;&nbsp;

										<label style="font-size: 23px"><b>結束日期:</b></label>
										<input type="text" placeholder="YYYY-MM-DD" name="enddate" id="datepickerEnd" style="width: 180px">
										&nbsp;&nbsp;

										<button class="querybtn" id="queryBtn">查詢</button>
									</div>
									<!-- 表格 -->
									<div id="tableA" style="">
										<table class="table table-bordered align-middle" style="margin-top: 40px;">
											<tr style="font-size: 19px;">
												<th style="background-color: burlywood;">服務日期</th>
												<th style="background-color: burlywood;">服務時間</th>
												<th style="background-color: burlywood;">服務項目</th>
												<th style="background-color: burlywood;">案主名稱</th>
												<th style="background-color: burlywood;">案主地址</th>
												<th style="background-color: burlywood;">備註</th>
												<th style="background-color: burlywood;">功能</th>
											</tr>

											@if (Model != null)
											{
												foreach (var item in Model)
												{
													<tr class="serviceRow" id="dataRow" style="font-size: 18px;">
														<td class="serviceDate">@item.ServiceDate.ToString("yyyy-MM-dd")</td>
														<td>@item.ServiceTime.ToString("hh\\:mm")</td>
														<td>@item.ServiceItem</td>
														<td>@item.EmployerName</td>
														<td>@item.ClientAddress</td>
														<td>@item.Remark</td>
														<td>
															<button class="cancel-btn btn btn-primary"
																	data-caseid="@item.CaseID"
																	data-date="@item.ServiceDate.ToString("yyyy-MM-dd")"
																	data-time="@item.ServiceTime.ToString("hh\\:mm")"
																	data-item="@item.ServiceItem"
																	data-employer="@item.EmployerName"
																	data-address="@item.ClientAddress">
																取消
															</button>
														</td>
													</tr>
												}
											}
											else
											{
												<tr>
													<td colspan="5">沒有歷史資料可顯示</td>
												</tr>
											}

										</table>
									</div>
								</div>
							</div>

						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script src="~/js/CsMember/jquery.twzipcode.min.js"></script>
	<script src="~/js/CsMember/getaddress.js"></script>
	<script src="~/js/CsMember/profile.js"></script>
	<script src="~/js/CsMember/Prev&Next.js"></script>
	<script src="~/js/CsMember/changeTabHref.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>


	<script>

		$(function () {
			$("#datepickerStart, #datepickerEnd").datepicker({
				dateFormat: "yy-mm-dd"
			});
		});

		$("#twzipcode").twzipcode();
		$("#twzipcode2").twzipcode();
		$("#twzipcode3").twzipcode();

	</script>

	<script>
		//從Session Storage中獲取用户帳戶資料
		$(document).ready(function () {
			var _userAccount = JSON.parse(sessionStorage.getItem('member')).account;
			console.log("userAccount:", _userAccount);

			// 使用 AJAX 將 userAccount 傳遞給 Controller
			$.ajax({
				url: '/Staff/Schedule',
				type: 'POST', // 或者 'GET'，取決於您的 Controller 設置
				data: { account: _userAccount },
				success: function () {
					// 成功回應
					console.log("請求userAccount成功");
					//console.log("回應資料:", response); // 可以查看返回的資料
				},
				error: function (xhr, status, error) {
					// 處理錯誤
					console.log("請求userAccount失敗");
					console.log("Status: ", status); // 可以查看錯誤狀態
					console.log("Error: ", error);   // 可以查看錯誤原因
				}
			});
		});

		//處理表單提交事件
		$("#queryBtn").click(function () {

			event.preventDefault(); // 阻止表單的默認提交行為

			var startDate = new Date($("#datepickerStart").val());
			var endDate = new Date($("#datepickerEnd").val());

			var hasData = false; // 檢查是否有資料

			$(".serviceRow").each(function () {
				var rowDate = new Date($(this).find(".serviceDate").text());
				if (rowDate >= startDate && rowDate <= endDate) {
					$(this).show();
					hasData = true;  // 如果有資料，設置為 true
				} else {
					$(this).hide();
				}
			});

			// 如果沒有資料，顯示"尚未有排程可顯示"
			if (!hasData) {
				$("#tableA").append('<tr><td colspan="5">尚未有排程可顯示</td></tr>');
			} else {
				$("#tableA td[colspan='5']").parent().remove(); // 移除可能存在的資料
			}

		});

		// 處理取消排程事件
		$(".cancel-btn").click(function (event) {

			var button = $(this);
			var caseId = button.data("caseid");
			var serviceDate = button.data("date");
			var serviceTime = button.data("time");
			var serviceItem = button.data("item");
			var employerName = button.data("employer");
			var clientAddress = button.data("address");

			event.preventDefault(); // 阻止表單的默認提交行為

			Swal.fire({
				title: '確定要取消排程嗎?',
				html: `<div style="display: flex; justify-content: center;">
								<div style="text-align: left;">
									<p>服務日期：${serviceDate}</p>
									<p>服務時間：${serviceTime}</p>
									<p>服務項目：${serviceItem}</p>
									<p>案主名稱：${employerName}</p>
									<p>案主地址：${clientAddress}</p>
								</div>
						</div>`,
				icon: 'warning',
				showCancelButton: true,
				confirmButtonText: '確定',
				cancelButtonText: '取消',
			}).then((result) => {
				if (result.isConfirmed) {
					// 如果用戶確定取消，將表單提交到後端控制器
					$.post('@Url.Action("CancelSchedule", "Staff")', { CaseId: caseId }, function () {
						// 成功提交表單後，彈出取消提示
						Swal.fire('取消成功', '排程已取消', 'success').then(() => {
							location.reload(); // 關閉 SweetAlert 後刷新頁面
						});
					});
				}
			});
		});

	</script>
</body>
